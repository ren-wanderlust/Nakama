# React Query + AsyncStorage 実装 - リスク分析

## 重大な問題の有無について

### 結論: **基本的に重大な問題はないが、いくつかの注意点がある**

---

## ✅ 問題なし（適切に実装されている）

### 1. データ更新の検知

**実装状況**: ✅ すべての主要データ取得に対してRealtime購読を実装

- **messagesテーブル**: 未読数・チャット一覧更新を即座に検知
- **likesテーブル**: マッチ・受信いいね更新を即座に検知
- **projectsテーブル**: プロジェクト一覧・マイプロジェクト更新を即座に検知
- **project_applicationsテーブル**: 応募一覧更新を即座に検知

**動作**: Realtimeイベント発火 → `invalidateQueries` → React Queryが自動的に再取得 → UI更新

**評価**: ✅ **問題なし** - データ変更時は即座に検知される

---

### 2. ユーザー操作後の更新

**実装状況**: ✅ すべての書き込み操作後に`invalidateQueries`を実行

- いいね送信/取り消し → `matches`をinvalidate
- プロジェクト作成/更新 → `projects` / `myProjects`をinvalidate
- 応募ステータス更新 → 関連するすべてのqueryKeyをinvalidate
- 既読マーク → 該当queryKeyをinvalidate

**評価**: ✅ **問題なし** - ユーザー操作後は確実に更新される

---

### 3. ネットワーク復帰時の自動再取得

**実装状況**: ✅ `refetchOnReconnect: true`により、ネットワーク復帰時に自動再取得

**動作**: オフライン→オンライン復帰時、すべての`stale`なクエリが自動再取得される

**評価**: ✅ **問題なし** - ネットワーク復帰時に確実に最新データを取得

---

### 4. オフライン時の挙動

**実装状況**: ✅ AsyncStorageキャッシュにより、オフライン時もキャッシュを表示可能

**動作**:
1. オフライン時: キャッシュを表示（最新でない可能性あり）
2. オンライン復帰時: すべての`stale`なクエリが自動再取得される

**評価**: ✅ **問題なし** - オフライン時もキャッシュを表示し、復帰時に自動更新

---

## ⚠️ 注意点（重大ではないが、認識しておくべき点）

### 1. staleTime経過後の自動再取得が実行されない

**問題の詳細**:
- `refetchOnMount: false`により、`staleTime`（1-5分）経過後でもマウント時には再取得しない
- バックグラウンドでの自動再取得も設定されていない

**実際の影響**:
- ユーザーが長時間アプリを開き続けた場合、`staleTime`経過後も古いデータが表示され続ける可能性がある

**ただし**:
- ✅ Realtime購読により、データ変更時は即座に検知される
- ✅ `refetchOnReconnect: true`により、ネットワーク復帰時には自動再取得される
- ✅ 手動`refetch`（`onRefresh`）により、ユーザーが明示的に更新できる

**評価**: ⚠️ **軽微な問題** - Realtime購読により実質的に問題なし。ただし、Realtimeイベントが届かない場合のみ影響あり

---

### 2. Realtimeイベントが届かない場合

**発生する可能性のあるケース**:
- Supabase Realtimeの一時的な不具合
- ネットワーク接続が不安定な状態（接続はあるが、Realtimeが切断されている）
- 長時間アプリをバックグラウンドにした後、フォアグラウンドに戻った時（Realtime接続が切断されている可能性）

**実際の影響**:
- データ変更が反映されない可能性がある
- ただし、`refetchOnReconnect: true`により、ネットワーク復帰時には自動再取得される

**現在の対策**:
- ✅ `refetchOnReconnect: true`により、ネットワーク復帰時に自動再取得
- ✅ 手動`refetch`（`onRefresh`）により、ユーザーが明示的に更新できる

**評価**: ⚠️ **軽微な問題** - ネットワーク復帰時や手動更新により解決可能

---

### 3. 長時間アプリを開き続けた場合

**シナリオ**:
- ユーザーがアプリを10分間開き続けた場合
- `staleTime`（1-5分）が経過している
- しかし、Realtimeイベントが届いていない（データ変更がない、またはRealtime接続が切断されている）

**実際の影響**:
- 古いデータが表示され続ける可能性がある
- ただし、データ変更があればRealtimeイベントで即座に検知される
- データ変更がなければ、古いデータでも問題ない

**評価**: ⚠️ **軽微な問題** - データ変更があればRealtimeで検知されるため、実質的に問題なし

---

## 🔍 詳細分析

### React Queryの動作仕様

**`refetchOnMount: false`の場合**:
- キャッシュがあれば、マウント時には再取得しない
- `staleTime`経過後でも、マウント時には再取得しない
- バックグラウンドでの自動再取得も実行されない

**`refetchOnReconnect: true`の場合**:
- ネットワークが切断→接続に戻った時、すべての`stale`なクエリが自動再取得される

**`invalidateQueries`の場合**:
- 即座に再取得が実行される（バックグラウンド）
- UIはキャッシュを表示しつつ、裏で最新データを取得して更新

---

### 実際のユーザー体験への影響

#### シナリオ1: 通常の使用（データ変更あり）

1. ユーザーがアプリを開く → キャッシュを即表示
2. 他のユーザーがデータを変更 → Realtimeイベント発火
3. `invalidateQueries`実行 → 自動再取得 → UI更新

**評価**: ✅ **問題なし** - 即座に更新される

---

#### シナリオ2: 長時間アプリを開き続けた場合（データ変更なし）

1. ユーザーがアプリを10分間開き続ける
2. `staleTime`（1-5分）が経過
3. データ変更がない → Realtimeイベントなし
4. 古いデータが表示され続ける

**評価**: ⚠️ **軽微な問題** - ただし、データ変更がなければ古いデータでも問題ない

---

#### シナリオ3: Realtimeイベントが届かない場合

1. ユーザーがアプリを開く → キャッシュを即表示
2. 他のユーザーがデータを変更
3. Realtimeイベントが届かない（ネットワーク問題、Supabase Realtimeの不具合等）
4. データ変更が反映されない

**現在の対策**:
- `refetchOnReconnect: true`により、ネットワーク復帰時に自動再取得
- 手動`refetch`（`onRefresh`）により、ユーザーが明示的に更新できる

**評価**: ⚠️ **軽微な問題** - ネットワーク復帰時や手動更新により解決可能

---

#### シナリオ4: オフライン時の使用

1. ユーザーがオフラインでアプリを使用
2. キャッシュを表示（最新でない可能性あり）
3. オンライン復帰 → `refetchOnReconnect: true`により自動再取得

**評価**: ✅ **問題なし** - オフライン時もキャッシュを表示し、復帰時に自動更新

---

## 📊 リスク評価まとめ

| リスク | 重大度 | 発生確率 | 影響範囲 | 対策状況 |
|--------|--------|----------|----------|----------|
| **staleTime経過後の自動再取得が実行されない** | 低 | 中 | 長時間アプリを開き続けた場合 | ✅ Realtime購読により実質的に問題なし |
| **Realtimeイベントが届かない場合** | 低 | 低 | ネットワーク問題、Supabase Realtimeの不具合 | ✅ `refetchOnReconnect: true`、手動`refetch` |
| **オフライン時の挙動** | なし | - | - | ✅ 適切に実装されている |
| **データ更新の検知** | なし | - | - | ✅ 適切に実装されている |
| **ユーザー操作後の更新** | なし | - | - | ✅ 適切に実装されている |

---

## 🎯 最終評価

### 重大な問題: **なし**

**理由**:
1. ✅ Realtime購読により、データ変更時は即座に検知される
2. ✅ すべての書き込み操作後に`invalidateQueries`を実行
3. ✅ ネットワーク復帰時に自動再取得
4. ✅ オフライン時もキャッシュを表示可能

### 軽微な注意点: **あり**

**内容**:
1. ⚠️ `staleTime`経過後でも、マウント時には自動再取得されない
   - ただし、Realtime購読により実質的に問題なし
2. ⚠️ Realtimeイベントが届かない場合、更新が反映されない可能性
   - ただし、ネットワーク復帰時や手動更新により解決可能

### 推奨される改善（オプション）

**優先度: 低**（現在の実装で十分機能している）

1. **Realtime接続の監視**:
   - Supabase Realtimeの接続状態を監視し、切断時に手動`refetch`を実行
   - ただし、`refetchOnReconnect: true`により、ネットワーク復帰時には自動再取得されるため、必須ではない

2. **staleTimeの調整**:
   - より短い`staleTime`を設定することで、より頻繁に再取得される
   - ただし、バッテリー消費が増える可能性がある

3. **バックグラウンドでの自動再取得**:
   - `refetchInterval`を設定して定期的に再取得
   - ただし、ポーリング禁止の方針に反する

---

## 結論

**アプリとして重大な問題はない**と判断します。

**理由**:
- ✅ データ変更時はRealtime購読により即座に検知される
- ✅ ユーザー操作後は確実に更新される
- ✅ ネットワーク復帰時に自動再取得される
- ✅ オフライン時もキャッシュを表示可能

**軽微な注意点**:
- ⚠️ `staleTime`経過後でも、マウント時には自動再取得されない（ただし、Realtime購読により実質的に問題なし）
- ⚠️ Realtimeイベントが届かない場合、更新が反映されない可能性（ただし、ネットワーク復帰時や手動更新により解決可能）

**推奨**:
- 現在の実装で十分機能しているため、追加の改善は必須ではない
- ただし、より堅牢にする場合は、Realtime接続の監視を追加することを検討
